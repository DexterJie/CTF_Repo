`shash`的结构和2024年5月CISCN——hash这题一样。做这题之前不妨再次回顾一下[DexterJie's Blog](https://dexterjie.github.io/2024/05/18/%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/2024CISCN/#%E7%94%A8%E6%A0%BC%E6%9D%A5%E5%81%9A)

# 2024CISCN——hash

在CISCN这题中，hash的计算过程如下：


$$
x_0 = s_0 \times 2^7
$$



$$
x_1 = ax_0 \mod MOD \otimes s_0
$$




$$
x_2 = ax_1 \mod MOD \otimes s_1
$$


$$
\vdots
$$




$$
x_7 = ax_6 \mod MOD \otimes s_6
$$



`res = x7 ^ length &  mask`

由于每一步存在异或操作，比较难处理。但注意到 $s_i$ 的取值范围为 $[0,255]$ ，这样的话 $\otimes s_i$ 可以看作 $\pm b_i$ 。于是hash的计算过程可以看作如下流程



$$
x_0 = b_0 \times 2^7
$$




$$
x_1 = ax_0 + b_0 \mod MOD
$$




$$
x_2 = ax_1 + b_1 \mod MOD
$$


$$
\vdots
$$


$$
x_7 = ax_6 + b_6 \mod MOD
$$



`res = x7 ^ length &  mask`

通过`res`这步求 $x_7$ 非常容易，如`x7 = res ^ length & mask`，所以直接从 $x_7$ 入手，经过上面的过程



$$
x_7 = (128a^7 + a_6)b_0 + a^5b_1 + ... + ab_5 + b_6 \mod MOD
$$



$b_i$ 的取值也介于 $[0,255]$ ，记`x7`为`c`通过造格规约出 $b_i$



$$
\begin{pmatrix}
b_0 & b_1 & ... b_{length - 1} & 1 & k
\end{pmatrix}
\begin{pmatrix}
1 & 0 & ... & 0 & 0& 128a^7+a^6\\
0 & 1 & ... & 0 & 0 & a^5\\
\vdots & \vdots & \ddots & \vdots & \vdots & \vdots \\
0 & 0 & ... & 1 & 0 & 1\\
0 & 0 & ... & 0 & 256 & -c\\
0 & 0 & ... & 0 & 0 &MOD
\end{pmatrix} = \begin{pmatrix}
b_0 & b_1 & ... & b_{length-1} & 256 & 0
\end{pmatrix}
$$



规约出 $b_i$ 之后，我们利用两个等式求原先的字符 $s_i$


$$
x_7 = ax_6 \mod MOD \otimes s_6 \quad (1)
$$




$$
x_7 = ax_6 + b_6 \mod MOD \quad (2)
$$



先计算 $ax_6 = x_7 - b_6 \mod MOD$ ，再计算 $s_6 = x_7 \otimes ax_6$ ，求出 $s_6$ 之后，计算 $x_6 = (x_7 \otimes s_6)\times a^{-1} \mod MOD$ ，以此类推。exp如下

```py
# sage10.6
from Crypto.Util.number import long_to_bytes
import hashlib
import binascii

mask = 0xffffffffffffffff
res = 7457312583301101235
cipher = 13903983817893117249931704406959869971132956255130487015289848690577655239262013033618370827749581909492660806312017
MOD = 2^64
a = 1000003

x7 = (res ^^ 7) & mask
xishu = [128*a^7+a^6,a^5,a^4,a^3,a^2,a,1]

length = len(xishu)

Ge = Matrix(ZZ,length+2,length+2)

for i in range(length):
    Ge[i,i] = 1
    Ge[i,-1] = xishu[i]
    
Ge[-2,-2] = 256
Ge[-2,-1] = -x7
Ge[-1,-1] = MOD

Ge[:,-1:] *= 2^200
c = x7
for line in Ge.LLL():
    key = b""
    if line[-1] == 0 and line[-2] == 256:
        tmp = line[:-2]
        for i in range(len(tmp)):
            tmpc = (c - tmp[6-i]) % 2^64             
            s = (tmpc ^^ c)
            key += long_to_bytes(s)
            c = (c ^^ s) * inverse(a,2^64) % 2^64
    m = int(hashlib.sha384(binascii.hexlify(key[::-1])).hexdigest(), 16) ^^ cipher
    print(long_to_bytes(m))
    # flag{bdb537aa-87ef-4e95-bea4-2f79259bdd07}
```

# 2025MiniL——ezhash

本题给出64对`(str,hash(str))`，任意取两对值用z3求解可以得到`key = 1000001`，把`key`记为`a`，本题的hash整体计算结构和上面那题一样，区别在迭代次数。

依旧把异或看作 $\pm b_i$ ，所以整个计算过程可以用下面这个多项式表达



$$
x_{32} = (128a^{32} + a^{31})b_0 + a^{30}b_1 + ... + ab_{30} + b_{31} \mod MOD
$$



`res = x32 ^ length & mask`

同样造格把 $b_i$ 规约出来，然后求原先字符串



$$
\begin{pmatrix}
b_0 & b_1 &...& b_{31} & 1 & k
\end{pmatrix}
\begin{pmatrix}
1 & 0 & ... & 0 &  0 & 128a^{32}+a^{31}\\
0 & 1 & ... & 0 & 0 & a^{30}\\
\vdots & \vdots & \ddots & \vdots & \vdots & \vdots\\
0 & 0 & ... & 1 & 0 & 1\\
0 & 0 & ... & 0 & 1 & -c\\
0 & 0 & ... & 0 & 0 & MOD
\end{pmatrix} = \begin{pmatrix}
b_0 & b_1 & ... & b_{31} & 1 & 0
\end{pmatrix}
$$






```py
from Crypto.Util.number import *
from z3 import *

def solve_key(pairs):
    s = Solver()
    key = BitVec('key', 128)
    mask = 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff

    for value,hash_value in pairs:
        x = (ord(value[0]) << 7) & mask
        for c in value:
            x = (key * x) & mask ^^ ord(c)
        x ^^= len(value) & mask
        s.add(x == hash_value)
    
    if s.check() == sat:
        return s.model()[key].as_long()
    else:
        return None
    

testvalue = ['tx4QYfj3lCTABrCoMsh3PPvQIM7dmIIw', 'jKLrKVRVpjjyrchL41IjMVkQMgSkyyig', 'fdbfg4185rfRJyhwCwc2flhmsCDuVOe8', 'ZL8h1XOKVNXkVh1ZcCHhDUvF4FO96139', 'HcDKLC1iMwoiWoGxaC5VNC78VHLt5JOI', 'GzGJsONsN8GSZxh6C89w0nzRiTaR3tkj', 'Qcc9vqEBGXYd8sZ3E94Ode6ChC3U53x7', 'kABKm4mE7AttOzac3eBXvIxKE9Ve0viT', 'IkxnSW31AuUGpVldXGopAxfzr5eTXc2u', 'rJ2LZ0uDPCWEwJzaGGalaWWHBbxrLH4h', 'bOlXdB5xVb2RQO0MAhLvzgOZpEo2hIdP', 'gRhoDgyxFFV5kBLwZxexhoHNd5BD81UE', 'Ij86fy7zhVOaapV76xI71IUC8utF6Ct6', 'T055KPGIWKhNIEPxAKW4MLMbmWDvEnLb', 'SQSSYTFryov8Bp1ckfjbUTTV8H3Z3Dr7', 'AzfvT7z8NXJ9u8ID6vgJ8Zml58F2k0iF', 'o3nEYw9XaNzgetmmwypTU7oePU04Tkhc', 'B44YjfhqOrlPg8XQJq2fhWEoGaCijfsc', 'b7cvfUfjvorVjDBW6DiXrZc3eBqx98Ro', '9MwfbmLtdmRRt0TONZ4zmd6NN7z7V8Eg', '2f7I0f65nopjOpIZzErAoqYSGl0tMo0x', 'PqvrJ3FmEuJh1ASIQ06RyYCXbe6426CY', 'c3C60OTDrIs5ZChP2hTAYvViDw43ARCK', 'D6a0NJ2JpwtTBCRJdw1DcXntMgRRyj2A', 'gJ0rEL4zyy8A6aKZ1H3N46rsQnY6UGGx', 'CD19v37d2jHu9YZMp20h70sm1Q3t1yOm', '7vt0C1SCNvPBqBm0YrJffbeLG8vS8388', 'o2KRrZQJLD7CMuLzlPJoJHXwVOHEanBi', 'Lm8I9m5ikXVrguEUFKw6yIc9QWnLwisx', 'kt9H0IDCsjCfqkR83aHD8D23jXq55q5K', 'HsXBVD2dMVTScHfgwAeNsqHkLCWuuaVn', 'QnkXRLGjzfh16icAVidcW4kVx1LEOv0j', '29dQWe0QWOxNAhv48Lfnv8II4IZqeUh1', 'E9Hj5zUhGXUfrNJRmhxF0KfBq0wSjX0i', 'mEc57IdmvliXneKStFzb3pAnNNm4UHbh', 'TvRZb6btVQeKXsO5iVuRCdz3A4ORZ5yQ', 'yOfrPTw9Vkd0P7kiijnGVYL4SogWF7cY', 'GNI7o11w4RyXYY2hnxdq1mAeVPrppkRc', 'YCMxUi7OcB5xozjTg09xXbJvwM6U4apy', '0g6ItBFoe3174e7wpEaEgoid0rixLHBs', 'bsyXlUGPUnQjoNwQLROwrA2SCkbDR1k5', 'CMNSNW3fU14ibZgL0ifWrA0xbbq7Yrks', 'VHfbRmzF9mzGCbYySdljWWo08IVCmAMZ', 'SLfmmSZ5TjDc4ZfKIB2gOVf9KIH2jDUi', 'YKTagkUhZjI0gMyaE1YjVJdCYtPGPZge', 'kCVhCGvjedxC44BlTqQryGdMliYqYrIz', 'HflxuwlJZ2rByOnv995gpXz03ZK6MLW2', '8Yy45IMlpMhDO3CFVhr5f0iRBnNuj3ut', 'Ydae2l7kt1O6mCIBRwjr6TWn6fLRHXjf', '3cLGeEXfyLnrL0ZkvgSEAbDBYgaFNFxB', '97xOFim3lkwqrWM1BqQ7c8mYo5S5TxkC', 'U1EgvNhZz3M8Hg38FsuBVG0PvuWiCfez', '1elLy7dgdfEtb2XyZMxaU6h8dGjfokjv', 'FlSHFSs2SeKNOUVAprkHdtD2FrIPUGIR', 'Bu1pVMZ5QqMmvBTdUt4IwsTpkclqwQKF', 'BPzJvHHDTAu23xBS1wVButTF7lU0JGoo', '6xje2blSl3QwGeV9D4pUmxMKJDqpyXpt', 'F2DkyxkRcHotO6i5MVUKzzDsxV2F69wh', 'kvSYBqmZNppDfweere2A8co50Tv85c4m', '9k5gxX8oz1WmVLtCcN4SdFIse2FizYDU', 'BJ2PCD5KgukjFWntZ3VSjcHJzIZprno2', 'Lyw9EacIjF6j6de3e5wFRQLdzrOfQoAR', 'egf9LJLJrWDIrtnsHZ4XRgoPTXNsz91a', 'Y3ptIW83Rwtny4kng2lCEAYQyPrSIXWl']
testhash = [139452903649273495774796570198749847935154848275416989998236609393670079561796026566, 1898315960650462382992557075551445244853390783794354772475023552166352399126801574913, 1548283380348601157365276865178627465508293067676981633220766480841355279423253644108, 923519463377078549688929962730292019193308698763374121309865664233390770048594933085, 1756902502089018688726236312608077708484907801835749190713532913735823397112051091188, 485883566823442644293538461674550566921074196968613685770142417532151624958507107972, 1173292014155884160226339046019271687659068020981556335907768031140876583959335792191, 1497598230931219654402725391331476099708291441530945577907300933091011484442911623559, 405254852716971084666570344588562007424273706832802434925282540786042396564117859893, 1394088214004563872208003758992014976825245306078851263986862009024422531466462221196, 1763510459716348629512798257958014024443432479861579028783119470126357343664438877507, 27569271776233701581922903599984775754217802504994237075390721310066121958700422257, 358721799072196562200934505713368644637409165736588969777736471282788507457480492393, 393768200956019495628870433474843666326783653588854234548113046584760291662872350533, 1807499005738194381232046747643492968233097104171420081977957810644000450496758434126, 1128375044917910760907836056160281710737671148936596789317429758098492329675588054412, 190801904376187850882600897701548299608718300961575858190394579710450430805489346060, 696235869802737571933351613461601576350495964954926712734858661433694663819119664403, 144629031178782625524039663692148786536912021223673544659451459599242746855791775856, 401144481698447351083363386545760097487182143265029898145794033656496473914256697335, 1009618288798575771577716476700225261222418219966898563557126734083036472365735018549, 1652157599124169823165290864340613818899678030477803381010155627950330279311151902666, 1870720516435595720338243705356357230346778004770545711499635272857342051185669675206, 1487151272734883591621339384743729579702945226647848932314811332859011211687393769612, 1479191883622650407012568261078896124452298448888937784127270669623167501587692263629, 780856915459110484827869192135025240964695263399685896704373351690074659693517658597, 1272702898194178848480618231703540760239057875392727193937165056708655804663623414520, 1275195323347307250910668562396243097983325652451465111552014287378408554253858874273, 1698673537783777278793781484130287999078310462163146951845044095951885080758156044986, 1116043791065172596267818286071095315966453133595258493434104767743854595678117184595, 1348107024738703857635485943338711096444282613588540975344171990396347335813147110414, 674079263421647723071324170291511267338891718494055820365382788749002205059725239586, 295061829951102865059369162125524442985720861319812067484094160955682413284464056261, 1538215242227433291697344636690665676070219615083515667029553094023114463154050936814, 721505087135717334627356208457079819823654955152265437431617001188458058923464437209, 1829121734506718678607427505722187801463532440435031915402835074237985549711879794153, 641638098138302116745154827833695010970508819483215023447636503844550651793330508318, 578773085269354102367810984562000052879291442293349350198300750627238557013515250567, 1037095172573176620769108515135124799537948207093565906631598569276504664097088051993, 1135701773556587743998667090148858666225101588783019121910187176364233349468967967460, 558240645642302963325581107204211662019896908316831899444935081810819489268610165950, 1058477746525469710567689847282850794170250650192794892415352733735415750154044535539, 1078948952548590509616082107408254715684287170445966544383750373684441181406075608800, 1125503915235599245173592373330463888468814720113318696411329986853859005519154551245, 620937641933659718470519231175003762666892925875327642171561741417944681106496958467, 1606192912497675735832389346699475593863960301930109653069662356606234973780336341534, 1080665036256326887412273484626209788664633047255179233142423471463514811554155351816, 983009583253660084055702843297933007090244160053834934015802835528599935867335658914, 483554778736863191047830758397092863562079726548422384268968936073701177390747179894, 1448392838363784830874780455853191313920717249664981009097361707739423512768919183176, 1485175804980546607220269493098915446350406205462077528986751407380405658199537322034, 645127338301455578293193215328875283422934699182904112612610112081929081505533458304, 1809012351380435986646710932772127842855528298763939575266488725018536037784342688529, 1204732789391044629328843397205785308919820285525150764490536624969971871178313643864, 577072907834194443039001358264806817627199891744275024388326836994220595931009773412, 4850110449540994875278068624822977611188629104877448016749725577673217396499782282, 1431458221917644050146055837804453915809781510516096707298405324221753990760039183190, 997966793625232984798176686099411790420209217223783698909939651134351713786805317998, 1663286211430268448119727051818073243067649643181675027323547282932628837598336996456, 1864894557154744961308146774304105483911867578158330607820790060568575114233028842003, 345822843952211153189889023070066136116424104740167243049994988868945364800740535124, 803699468991667968627856232995969437316168483382073633967569490433608395707635458855, 1700532832517222239684444041937412551935144886911006116260771516969538181780787023704, 351624945474123146509460066647337532150453362002844376810733781394757015795554947704]
pairs = [
    (testvalue[0],testhash[0]),
    (testvalue[1],testhash[1])
]
key = solve_key(pairs)
a = key
shash = 463802484547898091835999726502006552543022358314700124374789687370275467670717610329
mask = 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
MOD = mask + 1
length = 32
c = (shash ^^ length) & mask
xishu = []
for i in range(length-1):
    xishu.append(a ^ i)
xishu.append(128*a^(length) + a^(length-1))
xishu = xishu[::-1]

Ge = Matrix(ZZ,length+2,length+2)
for i in range(length):
    Ge[i,i] = 1
    Ge[i,-1] = xishu[i]
Ge[-2,-2] = 256
Ge[-2,-1] = -c
Ge[-1,-1] = MOD
Ge[:,-1:] *= 2^200
for line in Ge.LLL():
    if line[-1] == 0 and line[-2] == 256:
        tmp = line[:-2]
        flag = ""
        for i in range(len(tmp)):
            tmpc = (c - tmp[length - 1 - i]) % MOD
            m = (tmpc ^^ c)                         
            flag += chr(m)
            c = (c ^^ m) * inverse(a,MOD) % MOD
        print(flag[::-1])
        # miniL{W@!!_Y()o_get_T()@_SEcr@t}
```







