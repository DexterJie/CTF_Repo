`print(random.getrandbits(32)+flag[random.getrandbits(32)%len(flag)])`

可以看作一次交互给出两个getrandbits(32)中前者的高24bit（实际测试会发现，加上flag的某一个值之后，会影响到低20bit，所以后面取了12bit，这就导致需要的数据更多，矩阵规模变大）

这其实就是不连续的MT19937考点，需要造矩阵。参考：[huangx607087/Explore-MT19937](https://huangx607087.online/2021/07/10/Explore-MT19937/#0x03-%E7%BB%99%E5%87%BA%E4%BB%BB%E6%84%8F19937%E4%B8%AAbit-upd-2025-01-22)

在得到state之后，意味着下式的a,b我们都知道了


$$
c = a + m[b \mod length]
$$

$$
\therefore c - a = m[b \mod length]
$$

爆破length，在数据足够多的情况下应该是可以恢复flag的

https://blog.maple3142.net/2025/01/16/tscctf-2025-writeups/

> 恢复state

```py
from pwn import *
from sage.all import *
from tqdm import *
import random

unknow_bit = 20

sh = remote('1.95.57.127', 3001)

with open('./real_data.txt', 'w') as f:
    # for i in trange(19968 // (32 - unknow_bit)):
    for i in trange(2500):
        f.write(sh.recvline().decode())
        sh.sendline(b'xmcve')
print('数据获取完毕')

RNG = random.Random()
Dall = list(map(int, open('real_data.txt', 'r').readlines()))
Dall = [(i >> unknow_bit) << unknow_bit for i in Dall]
length = len(Dall)
print(length)

def construct_a_row(RNG):
    row = []
    for i in range(length):
        a = RNG.getrandbits(32)
        b = RNG.getrandbits(32)
        row += list(map(int, bin(a >> unknow_bit << unknow_bit)[2:].zfill(32)))
    return row

print("开始构造T矩阵")
T = []
for i in trange(19968):
    state = [0] * 624
    temp = "0" * i + "1" * 1 + "0" * (19968 - 1 - i)
    for j in range(624):
        state[j] = int(temp[32 * j:32 * j + 32], 2)
    RNG.setstate((3, tuple(state + [624]), None))
    T.append(construct_a_row(RNG))
T = Matrix(GF(2), T)
print(T.rank())
print("T矩阵构造完毕")
y = []
print("开始构造y向量")
for i in trange(length):
    y += list(map(int, bin(Dall[i])[2:].zfill(32)))
y = vector(GF(2), y)
print("y向量构造完毕")
s = T.solve_left(y)
print("求解完毕")
G = []
for i in range(624):
    C = 0
    for j in range(32):
        C <<= 1
        C |= int(s[32 * i + j])
    G.append(C)

RNG1 = random.Random()
for i in range(624):
    G[i] = int(G[i])
RNG1.setstate((int(3), tuple(G + [int(624)]), None))
print('state: ', (int(3), tuple(G + [int(624)]), None))
temp = []
for i in range(20):
    a = RNG1.getrandbits(32)
    b = RNG1.getrandbits(32)
    temp.append(a >> unknow_bit << unknow_bit)

print(temp)
print(Dall[:20])
```

如果T矩阵的秩不够大的情况下，恢复的state是不正确的。数据量一大就导致内存不够用，这题是让Harry师傅拿MAC跑的

> 求flag

```py
import random
import string

table = string.printable[:-6]
RNG = random.Random()
Dall = list(map(int, open('real_data.txt', 'r').readlines()))

state =  (3, (2147483648, 2938351286, 983961062, 1377414612, 2340578464, 2029094667, 1756003747, 3603977491, 2298953755, 1774755199, 1940120296, 664966565, 680139509, 3175303219, 1272245255, 2334681800, 4080679718, 4112169696, 2047083706, 4229572283, 3474166640, 992203239, 4177788370, 677192150, 1801694814, 1050947546, 2754102008, 2335707469, 1446881541, 2207621956, 175137268, 4149751610, 4138056279, 3313024360, 133148655, 97359402, 725951987, 2415034365, 4143651374, 758020228, 3486101728, 1763010333, 3705559464, 1212580247, 301411470, 873062078, 2488959278, 1689177684, 1513374848, 233721491, 1920403367, 1818889418, 4242657088, 3608765588, 1357009912, 1613444912, 2511162952, 412572684, 307184275, 68731362, 785311899, 504004798, 4160078560, 2000494845, 2783899303, 2251652250, 2539687987, 498349046, 3761736798, 653908615, 2441568119, 1963112756, 1169460280, 4238002019, 2492820822, 2379165321, 236913030, 941771073, 3118582859, 4177241872, 3385775396, 866615466, 3034260342, 3931734163, 2578100747, 3142582605, 1806859365, 1605503563, 662094221, 1141986658, 1892968001, 1592378653, 4199941182, 4021546935, 1983669830, 1746760570, 943118369, 1535288703, 2172803919, 3072682653, 3490749922, 143567687, 2495441905, 3872720887, 3241199084, 1567976697, 1608608986, 710504190, 1327210388, 452362779, 1615818367, 3223824369, 2854414851, 3359768871, 235034647, 3858179505, 3227030063, 1598198767, 1194321185, 271471413, 2107887394, 2559166768, 1002096011, 2197138314, 3897785599, 3105023530, 1121408527, 404697844, 2681074030, 1620419924, 3916367611, 2521321279, 612611838, 1026232399, 1106261903, 1857283107, 536971160, 3842950698, 319512488, 3156467537, 4215448564, 3243925496, 3930672048, 2516946812, 106265645, 4038727366, 3156817598, 3676721337, 3487534880, 4002955607, 1987441968, 3960833111, 2932082444, 1498151705, 3464508133, 1981340560, 3748080806, 148708229, 2262167057, 1855883381, 1869268258, 1858155537, 17550392, 4059639439, 4206328451, 1503247839, 4091457140, 3046000298, 2996223407, 844503663, 3096951106, 3563117461, 202483231, 2306463055, 1305420337, 2385877863, 864655931, 3489432835, 988422242, 2650823644, 3812531245, 3859102209, 1546408730, 1319146799, 2317943091, 1576224288, 1138761335, 3054145490, 3762433562, 1001672492, 2218885548, 4026649779, 1053326181, 121206065, 1890833318, 915942531, 3714456446, 3130921259, 951802615, 1070415781, 3614377234, 1147885984, 4278915957, 134774000, 412221005, 895932225, 3294991187, 541615016, 1236024342, 2571798701, 541483137, 1129698684, 1265412763, 2418753069, 2709263061, 585855008, 3574058805, 637968802, 2837473688, 1220889023, 448293436, 1044670811, 786232579, 846443904, 3144362712, 1012384520, 2209491099, 1047343191, 2886615799, 2596471556, 122279812, 2667462834, 1997682659, 3898177482, 67694141, 23320135, 1755947460, 598415033, 2654929322, 57957890, 2454922100, 3507404789, 1846167663, 1420567386, 2148914740, 1645039752, 3048031422, 567816399, 783741421, 999326063, 3086260039, 2158110500, 4258084946, 2836689928, 2276640230, 2920104452, 874275418, 3388188583, 4250312994, 2611736976, 2408763388, 3400914965, 1574944129, 4106324462, 2844718166, 457076585, 1980501265, 3925053602, 739850189, 4285364158, 2886133023, 2414827566, 342138241, 2309767159, 53900460, 2542780491, 121336283, 3766893491, 769130332, 4105715542, 593320502, 3988727155, 1525583257, 2431824911, 685791786, 4201549413, 1956612686, 3126554872, 3869608906, 1731909863, 4187490113, 577896113, 4069250007, 1474270346, 271439259, 629147395, 600335368, 3850868746, 2414669308, 2383509550, 64466199, 814308261, 3594807932, 1435498205, 802684846, 2282024825, 3480793168, 2063257251, 2860383623, 2210942360, 1669867493, 853877397, 924873177, 2424810117, 2909846482, 3615916019, 832334717, 3405279654, 1969043638, 2549592943, 3943809965, 1480786658, 3341948592, 1996326007, 128593545, 4109231770, 2387919651, 654993640, 253145649, 2956249345, 1226516591, 952923799, 1356283620, 4161211148, 1254787881, 4209440111, 151156432, 4111302931, 1998290868, 1226592237, 1907508368, 3416658890, 251833537, 3518024278, 2124405149, 2420790799, 531952425, 2933697279, 580257479, 763538451, 704680592, 3707273586, 1240034059, 3078540258, 19935341, 3655817217, 628170136, 2945669005, 4175341147, 2882466436, 174692274, 3223641125, 686603734, 942174165, 490863961, 456771670, 3857548297, 2956957837, 380925679, 1511625344, 1444175885, 2408753985, 1396628453, 2621857825, 978064337, 3299329616, 1663004740, 742967711, 2704140187, 2144373929, 1196205771, 570556470, 1481508645, 3128135676, 394417282, 308182369, 360454193, 4046908531, 1967349139, 3122308380, 2185351432, 747717907, 3424524152, 437529098, 4044070038, 2694712614, 3154615320, 1340615266, 603129791, 2268462640, 3290996515, 1401083500, 1830213512, 1347873991, 2631712424, 808187092, 3382759744, 2218468839, 3733940743, 4100778868, 2812633850, 3566122785, 2072621099, 3496671216, 3441539245, 107169851, 1857300714, 1148459143, 3967146459, 3696100475, 1820081478, 3988199380, 412556378, 901569663, 4163069092, 3229816740, 3574118042, 3986229728, 311643534, 902425575, 663832871, 1904752408, 1338929844, 2114136687, 3270527331, 718482387, 317992066, 2533986459, 4050753854, 551001831, 2806191130, 2125051077, 673958059, 3778141530, 1232808332, 3807666979, 832433391, 906864965, 3554603973, 2882081386, 3991759250, 2202058991, 3226474967, 3996354506, 3332175345, 3003974730, 3444366290, 3191493655, 3325993269, 1107923061, 2039058722, 2919046140, 883866961, 48421825, 650878747, 525835204, 1088742243, 3307992973, 730183318, 1025760506, 3298999916, 1921927537, 1015803029, 3312751987, 4143493976, 3850682509, 1631083748, 272830459, 1109674131, 1839430947, 1968816208, 879391174, 1289303066, 3818281165, 4031756894, 1700656843, 4115051764, 958573023, 1483117762, 2428566357, 1579815121, 787652912, 549804702, 2915663345, 570719535, 2758566063, 2395472683, 1837388467, 2692565403, 818529520, 1164474089, 2518762291, 545735395, 2583854693, 1321850673, 1276210126, 140789820, 756023887, 3516321408, 1039538263, 2700447004, 1119743273, 3631713605, 2665423697, 3668740252, 1699031217, 962793530, 2564977699, 2230278585, 2916273892, 3152226294, 3613592233, 2298902512, 3704850004, 1793113637, 195072103, 2929310897, 2652516913, 2480356929, 2299667300, 1317241732, 3327720511, 2545277349, 2481433538, 1779675667, 1522258654, 1265821857, 3549371168, 1266405659, 3158482938, 3423919465, 2067414334, 1188032020, 3983483806, 131911524, 1134110138, 612172872, 1968776034, 861683379, 3803678675, 4238732903, 1079514494, 200452030, 1284884589, 2693415241, 2707784640, 3519955898, 3110776523, 1240495214, 1486374376, 2777214968, 2284592337, 3267989328, 2862685591, 681810543, 2005142745, 2763374176, 1295501880, 221385700, 3907812524, 477692539, 3913491728, 1619746686, 1191196152, 2120015792, 3531133980, 232146103, 3145826123, 3422488314, 2222290057, 2913440968, 3807360829, 3021911262, 2107435786, 807005194, 1427383695, 2624235418, 2966732055, 3078437067, 4097129682, 1309651635, 2663416892, 2769402502, 1488464248, 3315834957, 1367480981, 3739793022, 2812804608, 3946586271, 1578011618, 365000619, 2315425544, 4120327077, 2279405238, 3904731682, 3310522568, 785903685, 1937602500, 1330480940, 478449660, 3376516509, 1977672860, 2389914447, 2339028017, 2510470610, 492087132, 457869913, 893281893, 2928086441, 2867436592, 2433248535, 2569395293, 2388114729, 110480196, 624), None)
RNG.setstate(state)
flags = []
index = []
for i in range(len(Dall)):
    a = RNG.getrandbits(32)
    b = RNG.getrandbits(32)
    tmp_flag = Dall[i]-a
    if 0< tmp_flag<255 and chr(tmp_flag) in table:
        flags.append(tmp_flag)
        index.append(b)

for flag_len in range(len(set(flags)), 100):
    tmp_index = [i%flag_len for i in index]
    tmp_flag = []
    for i in range(flag_len):
        if i in tmp_index:
            tt = tmp_index.index(i)
            tmp_flag.append(flags[tt])
        else:
            tmp_flag.append(ord('?'))
    tmp_flag =  bytes(tmp_flag)
    if tmp_flag.startswith(b'TPCTF{'):
        print(tmp_flag)  # TPCTF{Ez_MTI9937_pr3d1cTi0n}
```

## 第二种解法

利用到GF2BV，参考：[糖醋小鸡块/强网杯ECRandom Game](https://tangcuxiaojikuai.xyz/post/df3f7032.html#more)，但是这个mt19937函数根据什么原理修改有点没懂

> exp

```py
from gf2bv import LinearSystem
from gf2bv.crypto.mt import MT19937
from tqdm import *
from pwn import *

def mt19937(bs, out):
    lin = LinearSystem([32] * 624)
    mt = lin.gens()

    rng = MT19937(mt)
    zeros = []
    for o in out:
        zeros.append(rng.getrandbits(bs) ^ int(o))
        rng.getrandbits(32)
    zeros.append(mt[0] ^ int(0x80000000))
    sol = lin.solve_one(zeros)
    rng = MT19937(sol)
    pyrand = rng.to_python_random()
    return pyrand

if(0):
    unknow_bit = 20
    nums = 6000
    sh = remote('1.95.57.127', 3001)
    with open('./real_data.txt', 'w') as f:
        for i in trange(nums):
            f.write(sh.recvline().decode())
            sh.sendline(b'xmcve')
    print('数据获取完毕')

Dall = list(map(int, open('real_data.txt', 'r').readlines()))
C = Dall
Dall = [i >> unknow_bit for i in Dall]
length = len(Dall)
print(f"取了{length}组数据")
RNG = mt19937(12, Dall)
STATE = RNG.getstate()[1][:-1]
STATE = STATE + (len(STATE),)
print(f"STATE={STATE}")

for length in range(20,100):
    RNG.setstate((3,STATE,None))
    m = [0] * length
    for c in C:
        a = RNG.getrandbits(32)
        b = RNG.getrandbits(32)
        idx = b % length
        tmp = c - a
        if 0 < tmp < 256 and m[idx] == 0:
            m[idx] = tmp
    flag = bytes(m)
    if b'TPCTF' in flag:
        print(flag)
        break
        # TPCTF{Ez_MTI9937_pr3d1cTi0n}
```

